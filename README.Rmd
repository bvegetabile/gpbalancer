---
title: 'gpbalancer: Optimally Balanced Gaussian Process Propensity Score Estimation'
author: "Brian Vegetabile"
date: "11/17/2017"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# $\texttt{gpbalancer}$: an `R` Package for Optimally Balanced Gaussian Process Propensity Score Estimation

Reference forthcoming...


## Installing `gpbalancer`

The package `devtools` is required to install this `R` package from this Github repository.  Install this package first if it is not already installed.

```{r, echo=TRUE, eval=FALSE}
install.packages('devtools', dependencies = TRUE)
```

Once that package has been installed, use the following to install `gpbalancer`

```{r, echo=TRUE, eval=FALSE}
devtools::install_github('bvegetabile/gpbalancer')
```

Load the package to begin analysis!

```{r, echo=TRUE, eval=T}
library('gpbalancer')
```

## Example using `gpbalancer`



### Simulating data

Provided below is a simple simulation to explore the effectiveness of the optimally balanced Gaussian process propensity score. Consider a continuous covariate $X$ which is used to assign treatment, for $i \in 1, \dots, 500$ let,

\[
X_i \sim N(0,1)
\]

Additionally, let the true propensity score be defined as follows,

\[
e(X_i) = \mbox{Pr}(T_i = 1 | X_i) = 0.9 \times \Phi(2 * X_i) + 0.05
\]

where $\Phi(\cdot)$ is the cumulative distribution of the Normal Distribution.  Finally, we simulate treatment assignment such that,

\[
T_i | X_i \sim Bernoulli( \ e(X_i) \ )
\]


Additionally, we will consider the following potential outcomes

\[
Y_i^{T=1} = X_i^2 + 2 + \epsilon_{i,\mathcal{T}}
\]

\[
Y_i^{T=0} = X_i + \epsilon_{i,\mathcal{C}}
\]

where $\epsilon_{i,G} \sim N(0, 0.25^2)$ for $G \in \{\mathcal{T},\mathcal{C}\}$.  The observed outcome will be,

\[
Y_i^{obs} = I(T_i=1)Y_i^{T=1} + I(T=0)Y_i^{T=0}
\]

```{r, echo=TRUE, eval=T}
set.seed(201711)
n_obs <- 500
pretreatment_cov <- rnorm(n_obs)
prop_score <- 0.9 * pnorm(2*pretreatment_cov) + 0.05
treatment_assignment <- rbinom(n_obs, size = 1, prob = prop_score)
ta_logical <- as.logical(treatment_assignment)
y_t <- pretreatment_cov^2 + 2 + rnorm(n_obs, sd=0.25)
y_c <- pretreatment_cov + rnorm(n_obs, sd=0.25)
y_obs <- treatment_assignment * y_t + (1-treatment_assignment) * y_c

t_col <- rgb(0.5,0,0.5,0.5)
c_col <- rgb(0,0.5,0,0.5)
```

### Visualizing the Propensity Score & Covariate Imbalance

The true propensity score and observed treatment assignments are shown below.

```{r, echo=TRUE, eval=T, fig.width=14}
par(mfrow=c(1,2))
plot(pretreatment_cov, prop_score, 
     xlim=range(pretreatment_cov), 
     ylim=c(0,1),
     pch=19, col=rgb(0,0,0,0.5),
     xlab='Pretreatment Covariate',
     ylab='Probability of Treatment',
     main='Propensity Score & Observed Treatment Assignments')
points(pretreatment_cov[ta_logical],
       treatment_assignment[ta_logical],
       pch=19, col=t_col)
points(pretreatment_cov[!ta_logical],
       treatment_assignment[!ta_logical],
       pch=19, col=c_col)
abline(h=c(0,1), lty=3)
legend('topleft', c('Treated', 'Control'), pch=19, col=c(t_col, c_col), bg='white')

plot(density(pretreatment_cov[!ta_logical], adjust = 1.5),
     xlim=range(pretreatment_cov), 
     type='l', lwd=3, col=c_col,
     xlab='Pretreatment Covariate',
     ylab='Density',
     main='Covariate Distributions Conditional Upon Treatment Type')
lines(density(pretreatment_cov[ta_logical], adjust = 1.5),
     lwd=3, col=t_col)
abline(h=c(0,1), lty=3)
legend('topleft', c('Treated', 'Control'), lty=1, lwd=3, col=c(t_col, c_col), bg='white')
```

### Visualizing the Potential Outcomes & Observed Responses

Below are visualizations of the expectations of the potential response functions and the observed responses for the sample data.  

```{r, echo=TRUE, eval=T, fig.width=10, fig.height=5}
exes <- seq(min(pretreatment_cov), 
            max(pretreatment_cov), 
            0.01)
meanYT <- exes^2 + 2
meanYC <- exes
ylims <- range(cbind(meanYT, meanYC))

plot(exes, meanYT,
     type='l', lwd=3, col = t_col,
     xlim=range(pretreatment_cov), ylim=ylims,
     xlab='Pretreatment Covariate',
     ylab='Response',
     main='Expectation of Potential Response Functions\nAnd Observed Response Values')
lines(exes, meanYC, lwd=3, col = c_col)
points(pretreatment_cov[ta_logical], y_obs[ta_logical], pch=19, col=t_col)
points(pretreatment_cov[!ta_logical], y_obs[!ta_logical], pch=19, col=c_col)
legend('topleft', 
       c(expression(E(Y^{T==1})), 
         expression(E(Y^{T==0})),
         expression(paste('Treated Group, ', Y^{obs})), 
         expression(paste('Control Group, ', Y^{obs}))), 
       lty=c(1,1,NA,NA), lwd=c(3,3,NA,NA), pch=c(NA, NA, 19, 19), col=c(t_col, c_col), bg='white')
```

Under these settings if we are attempting to model $\tau = E(Y^{T=1} - Y^{T=0})$ without adjustment (i.e. using $E(Y^{obs} | T=1) - E(Y^{obs} | T=0))$, then the bias would be approximately 0.6. 

```{r, echo=TRUE, eval=T}
hat_tau <- mean(y_obs[ta_logical]) - mean(y_obs[!ta_logical])
original_bias <- (hat_tau-3)
```


